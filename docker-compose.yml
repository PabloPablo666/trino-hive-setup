version: '3.8'

services:
  postgres:
    image: postgres:13
    container_name: postgres
    environment:
      - POSTGRES_USER=hive
      - POSTGRES_PASSWORD=hive
      - POSTGRES_DB=metastore_db
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - trino-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d metastore_db"]
      interval: 5s
      timeout: 3s
      retries: 30

  hive-metastore:
    image: apache/hive:4.0.0
    container_name: hive-metastore
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - SERVICE_NAME=metastore
      - DB_DRIVER=postgres
      - SERVICE_OPTS=-Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://postgres:5432/metastore_db -Djavax.jdo.option.ConnectionUserName=hive -Djavax.jdo.option.ConnectionPassword=hive
    ports:
      - "9083:9083"
    volumes:
      - ./libs/postgresql-42.6.0.jar:/opt/hive/lib/postgresql-42.6.0.jar
      - ${DISCOGS_DATA_LAKE}:/data/hive-data
    networks:
      - trino-net
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/localhost/9083'"]
      interval: 5s
      timeout: 3s
      retries: 60

  trino:
    image: trinodb/trino:415
    container_name: trino
    depends_on:
      hive-metastore:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      # ✅ Monta SOLO i file config (niente /etc/trino intero)
      - ./trino-config/config.properties:/etc/trino/config.properties:ro
      - ./trino-config/jvm.config:/etc/trino/jvm.config:ro
      - ./trino-config/node.properties:/etc/trino/node.properties:ro

      # ✅ Catalog reale (quello del repo, non roba duplicata)
      - ./trino-catalog:/etc/trino/catalog:ro

      # ✅ Data lake
      - ${DISCOGS_DATA_LAKE}:/data/hive-data

      # ✅ Bootstrap SQL (se lo usi)
      - ./bootstrap_discogs.sql:/etc/trino/bootstrap_discogs.sql:ro
    networks:
      - trino-net
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/localhost/8080 && echo -e \"GET /v1/info HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\" >&3 && head -n 1 <&3 | grep -q \"200\"'"]
      interval: 10s
      timeout: 5s
      retries: 60

networks:
  trino-net:
    driver: bridge

volumes:
  pgdata:
